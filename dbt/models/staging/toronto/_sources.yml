version: 2

sources:
  - name: toronto
    description: "Toronto data loaded from CMHC and City of Toronto sources"
    database: portfolio
    schema: raw_toronto
    # TODO: Add source freshness once loaded_at columns are added via migration
    # freshness:
    #   warn_after: {count: 48, period: hour}
    #   error_after: {count: 168, period: hour}
    #   loaded_at_field: updated_at  # Requires migration to add this column
    tables:
      - name: fact_rentals
        description: "CMHC annual rental survey data by zone and bedroom type"
        columns:
          - name: id
            description: "Primary key"
          - name: date_key
            description: "Foreign key to dim_time"
          - name: zone_key
            description: "Foreign key to dim_cmhc_zone"

      - name: dim_cmhc_zone
        description: >
          CMHC zone dimension. Currently contains the Toronto CMA
          aggregate zone (TORCMA) with geometry. Sub-zone boundaries
          (31 zones) exist in data/toronto/raw/geo/cmhc_zones.geojson
          but are not yet loaded.
        columns:
          - name: zone_key
            description: "Primary key"
          - name: zone_code
            description: "CMHC zone code"
          - name: geometry
            description: "PostGIS MULTIPOLYGON geometry (SRID 4326). Contains TORCMA aggregate zone boundary."

      - name: dim_neighbourhood
        description: "City of Toronto neighbourhoods (158 official boundaries)"
        columns:
          - name: neighbourhood_id
            description: "Primary key"

      - name: dim_policy_event
        description: "Housing policy events for annotation"
        columns:
          - name: event_id
            description: "Primary key"

      - name: fact_census
        description: "Census demographics by neighbourhood and year"
        columns:
          - name: id
            description: "Primary key"
          - name: neighbourhood_id
            description: "Foreign key to dim_neighbourhood"
          - name: census_year
            description: "Census year (2016, 2021, etc.)"
          - name: population
            description: "Total population"
          - name: median_household_income
            description: "Median household income"

      - name: fact_crime
        description: "Crime statistics by neighbourhood, year, and type"
        columns:
          - name: id
            description: "Primary key"
          - name: neighbourhood_id
            description: "Foreign key to dim_neighbourhood"
          - name: year
            description: "Statistics year"
          - name: crime_type
            description: "Type of crime"
          - name: count
            description: "Number of incidents"
          - name: rate_per_100k
            description: "Rate per 100,000 population"

      - name: fact_amenities
        description: "Amenity counts by neighbourhood and type"
        columns:
          - name: id
            description: "Primary key"
          - name: neighbourhood_id
            description: "Foreign key to dim_neighbourhood"
          - name: amenity_type
            description: "Type of amenity (parks, schools, transit)"
          - name: count
            description: "Number of amenities"
          - name: year
            description: "Reference year"

      - name: bridge_cmhc_neighbourhood
        description: "CMHC zone to neighbourhood mapping with area weights"
        columns:
          - name: id
            description: "Primary key"
          - name: cmhc_zone_code
            description: "CMHC zone code"
          - name: neighbourhood_id
            description: "Neighbourhood ID"
          - name: weight
            description: "Proportional area weight (0-1)"

      - name: fact_neighbourhood_profile
        description: >
          Neighbourhood community profile data (immigration, visible minorities,
          languages, ethnic origin, etc.) from Statistics Canada 2021 Census
        columns:
          - name: id
            description: "Primary key"
          - name: neighbourhood_id
            description: "Foreign key to dim_neighbourhood"
          - name: census_year
            description: "Census year (2021)"
          - name: category
            description: "Profile category (immigration_status, visible_minority, mother_tongue, etc.)"
          - name: subcategory
            description: "Specific subcategory within the category"
          - name: count
            description: "Count value (NULL = Statistics Canada suppressed)"
          - name: level
            description: "Hierarchy level for place_of_birth (continent or country); empty for other categories"
          - name: category_total
            description: "Section header total count (set only on indent_level=0 rows; NULL on all detail rows). Used as denominator for pct_of_neighbourhood."
          - name: indent_level
            description: "XLSX hierarchy depth: 0=section header, 2=subtotal, 4=leaf detail row"

      - name: fact_census_extended
        description: >
          Wide-format scalar census indicators per neighbourhood (Path B extraction).
          ~55 pre-computed scalar indicators extracted directly from the Statistics Canada
          2021 Neighbourhood Profile XLSX. Grain: one row per (neighbourhood_id, census_year).
          All indicator columns nullable for Statistics Canada suppression.
        columns:
          - name: id
            description: "Primary key"
          - name: neighbourhood_id
            description: "Foreign key to dim_neighbourhood"
          - name: census_year
            description: "Census year (2021)"
